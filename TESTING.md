# Testing Guide

This document explains our testing approach, how to run tests, understand coverage reports, and contribute new tests to the NimLisp project.

## Overview

NimLisp uses **Testament** (Nim's official test framework) for testing with **real code coverage** reporting via gcov/lcov. This provides industry-standard line-by-line coverage analysis.

## Quick Commands

```bash
# Run all tests
make test

# Generate coverage report and update badges
make badges

# View detailed HTML test report
open testresults.html

# View detailed HTML coverage report
open coverage_html/index.html  # Generated automatically with `make badges`
```

## Test Framework: Testament

### Why Testament?

- **Official Nim test framework** - Built and maintained by Nim core team
- **Process isolation** - Each test runs in its own process
- **Multiple targets** - Supports C, C++, JavaScript compilation
- **HTML reporting** - Beautiful test result reports
- **Integration ready** - Works seamlessly with coverage tools

### Test File Structure

Testament tests are located in `tests/` and follow the naming pattern `t_*.nim`:

```
tests/
â”œâ”€â”€ t_ast.nim        # AST construction and manipulation tests
â”œâ”€â”€ t_evaluator.nim  # Expression evaluation tests  
â”œâ”€â”€ t_lexer.nim      # Tokenization tests
â”œâ”€â”€ t_parser.nim     # Parsing tests
â”œâ”€â”€ t_repl.nim       # REPL functionality tests
â””â”€â”€ t_token.nim      # Token creation tests
```

### Writing Tests

Testament tests use a special comment block format:

```nim
discard """
  action: "run"
  exitcode: 0
"""

import ../src/ast

# Test create number node
block:
    let node = newNumber(42)
    assert node.kind == nkNumber
    assert node.numberValue == 42

# Test create string node
block:
    let node = newString("hello")
    assert node.kind == nkString
    assert node.stringValue == "hello"

echo "All tests passed!"
```

**Key Points:**
- Each `block:` is an individual test case
- Use `assert` for test assertions (not `check` from unittest)
- Include descriptive comments for each test block
- End with an echo statement for successful completion

## Code Coverage

### Real Coverage with gcov/lcov

We use **gcov** and **lcov** for real line-by-line code coverage analysis, not estimation.

#### Prerequisites

Install lcov:
```bash
# Ubuntu/Debian
sudo apt install lcov

# macOS
brew install lcov

# Fedora/RHEL
sudo dnf install lcov
```

#### How It Works

1. **Compile with coverage flags**: `--debugger:native --passC:--coverage --passL:--coverage`
2. **Run tests**: Execute compiled test binaries to generate `.gcda` files
3. **Capture coverage**: Use `lcov` to process coverage data from `~/.cache/nim/`
4. **Generate report**: Create HTML coverage report and extract percentage

#### Coverage Files Location

Nim stores coverage data in:
- **Coverage files**: `~/.cache/nim/*/` 
- **Report files**: `testresults.html` (tests), coverage HTML (generated by lcov)

#### Understanding Coverage Results

**Coverage Badge Colors:**
- ðŸŸ¢ **Green (70%+)**: Good coverage
- ðŸŸ¡ **Yellow (50-70%)**: Adequate coverage  
- ðŸ”´ **Red (<50%)**: Needs improvement

**Current Status:** 59.0% coverage - room for improvement!

#### Manual Coverage Generation

```bash
# Clean previous coverage data
find ~/.cache/nim -name '*.gcda' -delete

# Compile tests with coverage
for test in tests/t_*.nim; do
    nim c --debugger:native --passC:--coverage --passL:--coverage "$test"
done

# Run tests to generate coverage data
for test in tests/t_*; do
    [ -x "$test" ] && "$test"
done

# Capture coverage
lcov --capture --directory ~/.cache/nim --output-file coverage.info

# Filter out system files
lcov --remove coverage.info '/usr/*' '*/choosenim/*' --output-file coverage_filtered.info

# Generate HTML report
genhtml coverage_filtered.info --output-directory coverage_html

# View report
open coverage_html/index.html
```

## Test Categories

### Unit Tests
- **AST Tests** (`t_ast.nim`): Node creation, manipulation, string representation
- **Token Tests** (`t_token.nim`): Token creation and properties
- **Lexer Tests** (`t_lexer.nim`): Tokenization of various inputs
- **Parser Tests** (`t_parser.nim`): S-expression parsing
- **Evaluator Tests** (`t_evaluator.nim`): Expression evaluation

### Integration Tests
- **REPL Tests** (`t_repl.nim`): End-to-end REPL functionality

## Contributing Tests

### Adding New Tests

1. **Create test file** following `t_<module>.nim` pattern
2. **Add Testament comment block** at the top
3. **Import necessary modules**
4. **Write test blocks** with descriptive comments
5. **Use assert statements** for verification
6. **Add success message** at the end

Example new test file:
```nim
discard """
  action: "run"
  exitcode: 0
"""

import ../src/mymodule

# Test basic functionality
block:
    let result = myFunction(42)
    assert result == expectedValue

echo "MyModule tests passed!"
```

### Test Guidelines

**Do:**
- âœ… Write descriptive test names in comments
- âœ… Test both success and error cases
- âœ… Use `assert` statements for verification
- âœ… Keep tests focused and atomic
- âœ… Test edge cases and boundary conditions

**Don't:**
- âŒ Mix unittest and Testament styles in same file
- âŒ Create overly complex test setups
- âŒ Test implementation details instead of behavior
- âŒ Forget to test error conditions

### Running Specific Tests

```bash
# Run single test file
testament run tests/t_ast.nim --print

# Run tests matching pattern
testament pattern "tests/t_ast*" --print

# Run all Testament tests
testament pattern "tests/t*.nim" --print
```

## Continuous Integration

The project can be integrated with CI systems:

```yaml
# Example GitHub Actions
- name: Run tests
  run: make test

- name: Generate coverage
  run: make badges

- name: Upload coverage
  # Upload testresults.html and coverage data
```

## Troubleshooting

### Common Issues

**"lcov not found"**
```bash
# Install lcov first
sudo apt install lcov  # Ubuntu
brew install lcov      # macOS
```

**"No coverage data found"**
```bash
# Check if tests compiled with coverage flags
ls ~/.cache/nim/*/
# Should see .gcda and .gcno files
```

**Tests pass but coverage is 0%**
```bash
# Ensure tests actually ran and generated coverage
find ~/.cache/nim -name "*.gcda" | wc -l
# Should be > 0
```

**Permission errors in coverage**
```bash
# Clean cache and retry
rm -rf ~/.cache/nim/*
make badges
```

## Badge System Integration

The testing system integrates with our badge generation:

- **Test Count**: Counts individual `block:` statements in Testament files
- **Coverage Percentage**: Real lcov line coverage, not estimation  
- **Test Status**: Green if all tests pass, red if any fail
- **Build Status**: Compilation success/failure

Run `make badges` after adding tests to update README badges.

---

For questions or issues with testing, please check the [main README](README.md) or open an issue.